<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - CMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/admin.css" rel="stylesheet">
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <%- include('../partials/sidebar') %>
        
        <!-- Main content -->
        <div class="main-content">
            <!-- Header -->
            <%- include('../partials/header') %>
            
            <!-- Product form content -->
            <div class="container-fluid p-4">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="h3 mb-0">
                                <i class="bi bi-box-seam me-2"></i>
                                <%= action === 'create' ? 'Nieuw Product' : 'Product Bewerken' %>
                            </h1>
                            <a href="/admin/products" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>
                                Terug naar overzicht
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <% if (typeof success !== 'undefined' && success) { %>
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        <%= success %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>
                
                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <form method="POST" action="<%= action === 'create' ? '/admin/products' : '/admin/products/' + product.id + '?_method=PUT' %>" 
                      class="needs-validation" novalidate>
                    <div class="row">
                        <!-- Main Product Info -->
                        <div class="col-lg-8">
                            <div class="card dashboard-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Basisinformatie
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <label for="name" class="form-label">Productnaam *</label>
                                            <input type="text" class="form-control" id="name" name="name" 
                                                   value="<%= product ? product.name : '' %>" required>
                                            <div class="invalid-feedback">
                                                Productnaam is verplicht
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="sku" class="form-label">SKU *</label>
                                            <input type="text" class="form-control" id="sku" name="sku" 
                                                   value="<%= product ? product.sku : '' %>" required>
                                            <div class="invalid-feedback">
                                                SKU is verplicht
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="slug" class="form-label">URL Slug</label>
                                            <input type="text" class="form-control" id="slug" name="slug" 
                                                   value="<%= product ? product.slug : '' %>" placeholder="Automatisch gegenereerd">
                                            <div class="form-text">Laat leeg voor automatische generatie</div>
                                        </div>
                                        <div class="col-12">
                                            <label for="short_description" class="form-label">Korte beschrijving</label>
                                            <textarea class="form-control" id="short_description" name="short_description" 
                                                      rows="2" placeholder="Korte samenvatting van het product"><%= product ? product.short_description || '' : '' %></textarea>
                                        </div>
                                        <div class="col-12">
                                            <label for="description" class="form-label">Uitgebreide beschrijving</label>
                                            <textarea class="form-control" id="description" name="description" 
                                                      rows="6" data-auto-resize placeholder="Volledige productbeschrijving"><%= product ? product.description || '' : '' %></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing -->
                            <div class="card dashboard-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-currency-euro me-2"></i>
                                        Prijzen
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="price" class="form-label">Reguliere prijs (€) *</label>
                                            <input type="number" class="form-control" id="price" name="price" 
                                                   step="0.01" min="0" value="<%= product ? product.price : '' %>" required>
                                            <div class="invalid-feedback">
                                                Prijs is verplicht
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="sale_price" class="form-label">Aanbiedingsprijs (€)</label>
                                            <input type="number" class="form-control" id="sale_price" name="sale_price" 
                                                   step="0.01" min="0" value="<%= product ? product.sale_price || '' : '' %>">
                                            <div class="form-text">Laat leeg als er geen aanbieding is</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inventory -->
                            <div class="card dashboard-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-boxes me-2"></i>
                                        Voorraad
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="manage_stock" 
                                                       name="manage_stock" value="1" <%= product && product.manage_stock ? 'checked' : '' %>>
                                                <label class="form-check-label" for="manage_stock">
                                                    Voorraad beheren
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6" id="stock_fields">
                                            <label for="stock_quantity" class="form-label">Voorraad aantal</label>
                                            <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" 
                                                   min="0" value="<%= product ? product.stock_quantity : '0' %>">
                                        </div>
                                        <div class="col-md-6" id="stock_status_field">
                                            <label for="stock_status" class="form-label">Voorraad status</label>
                                            <select class="form-select" id="stock_status" name="stock_status">
                                                <option value="instock" <%= product && product.stock_status === 'instock' ? 'selected' : '' %>>Op voorraad</option>
                                                <option value="outofstock" <%= product && product.stock_status === 'outofstock' ? 'selected' : '' %>>Uitverkocht</option>
                                                <option value="onbackorder" <%= product && product.stock_status === 'onbackorder' ? 'selected' : '' %>>Nabestelling</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO -->
                            <div class="card dashboard-card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-search me-2"></i>
                                        SEO
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="meta_title" class="form-label">Meta titel</label>
                                            <input type="text" class="form-control" id="meta_title" name="meta_title" 
                                                   value="<%= product ? product.meta_title || '' : '' %>" maxlength="60">
                                            <div class="form-text">Maximaal 60 karakters</div>
                                        </div>
                                        <div class="col-12">
                                            <label for="meta_description" class="form-label">Meta beschrijving</label>
                                            <textarea class="form-control" id="meta_description" name="meta_description" 
                                                      rows="3" maxlength="160" placeholder="Korte beschrijving voor zoekmachines"><%= product ? product.meta_description || '' : '' %></textarea>
                                            <div class="form-text">Maximaal 160 karakters</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="col-lg-4">
                            <!-- Product Status -->
                            <div class="card dashboard-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-gear me-2"></i>
                                        Status
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="category_id" class="form-label">Categorie</label>
                                        <select class="form-select" id="category_id" name="category_id">
                                            <option value="">Geen categorie</option>
                                            <% categories.forEach(category => { %>
                                            <option value="<%= category.id %>" <%= product && product.category_id == category.id ? 'selected' : '' %>>
                                                <%= category.name %>
                                            </option>
                                            <% }) %>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="active" 
                                                   name="active" value="1" <%= !product || product.active ? 'checked' : '' %>>
                                            <label class="form-check-label" for="active">
                                                Product actief
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="featured" 
                                                   name="featured" value="1" <%= product && product.featured ? 'checked' : '' %>>
                                            <label class="form-check-label" for="featured">
                                                Uitgelicht product
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Details -->
                            <div class="card dashboard-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-list-ul me-2"></i>
                                        Details
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="brand" class="form-label">Merk</label>
                                        <input type="text" class="form-control" id="brand" name="brand" 
                                               value="<%= product ? product.brand || '' : '' %>">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="model" class="form-label">Model</label>
                                        <input type="text" class="form-control" id="model" name="model" 
                                               value="<%= product ? product.model || '' : '' %>">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="weight" class="form-label">Gewicht (kg)</label>
                                        <input type="number" class="form-control" id="weight" name="weight" 
                                               step="0.1" min="0" value="<%= product ? product.weight || '' : '' %>">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="dimensions" class="form-label">Afmetingen</label>
                                        <input type="text" class="form-control" id="dimensions" name="dimensions" 
                                               value="<%= product ? product.dimensions || '' : '' %>" 
                                               placeholder="L x B x H">
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-<%= action === 'create' ? 'plus-lg' : 'check-lg' %> me-2"></i>
                                            <%= action === 'create' ? 'Product Aanmaken' : 'Wijzigingen Opslaan' %>
                                        </button>
                                        <a href="/admin/products" class="btn btn-outline-secondary">
                                            <i class="bi bi-x-lg me-2"></i>
                                            Annuleren
                                        </a>
                                        <% if (action === 'edit' && product) { %>
                                        <hr>
                                        <button type="button" class="btn btn-outline-danger" onclick="deleteProduct(<%= product.id %>)">
                                            <i class="bi bi-trash me-2"></i>
                                            Product Verwijderen
                                        </button>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin.js"></script>
    <script>
        // Auto-generate slug from name
        document.getElementById('name').addEventListener('input', function() {
            const slugField = document.getElementById('slug');
            if (!slugField.value || slugField.dataset.autoGenerated) {
                const slug = window.AdminUtils.slugify(this.value);
                slugField.value = slug;
                slugField.dataset.autoGenerated = 'true';
            }
        });

        // Mark slug as manually edited
        document.getElementById('slug').addEventListener('input', function() {
            if (this.value) {
                delete this.dataset.autoGenerated;
            }
        });

        // Toggle stock fields based on manage_stock checkbox
        const manageStockCheckbox = document.getElementById('manage_stock');
        const stockFields = document.getElementById('stock_fields');
        const stockStatusField = document.getElementById('stock_status_field');

        function toggleStockFields() {
            if (manageStockCheckbox.checked) {
                stockFields.style.display = 'block';
                stockStatusField.style.display = 'block';
            } else {
                stockFields.style.display = 'none';
                stockStatusField.style.display = 'none';
            }
        }

        manageStockCheckbox.addEventListener('change', toggleStockFields);
        toggleStockFields(); // Initial state

        // Character counters
        function setupCharacterCounter(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            const counter = document.createElement('small');
            counter.className = 'form-text text-muted';
            field.parentNode.appendChild(counter);

            function updateCounter() {
                const remaining = maxLength - field.value.length;
                counter.textContent = `${field.value.length}/${maxLength} karakters`;
                counter.className = `form-text ${remaining < 10 ? 'text-danger' : 'text-muted'}`;
            }

            field.addEventListener('input', updateCounter);
            updateCounter();
        }

        setupCharacterCounter('meta_title', 60);
        setupCharacterCounter('meta_description', 160);

        // Delete product function
        <% if (action === 'edit' && product) { %>
        function deleteProduct(productId) {
            if (!confirm('Weet je zeker dat je dit product wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.')) {
                return;
            }

            fetch(`/admin/products/${productId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.adminDashboard.showAlert(data.success, 'success');
                    setTimeout(() => {
                        window.location.href = '/admin/products';
                    }, 1000);
                } else {
                    window.adminDashboard.showAlert(data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                window.adminDashboard.showAlert('Er is een fout opgetreden', 'danger');
            });
        }
        <% } %>
    </script>
</body>
</html>
